unit uMain;

interface

uses
  // Пользовательские модули
  uCarDetector, uSpyTaxiTypes, dxMapItem
  //
    , Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, cxGraphics, cxControls, cxLookAndFeels,
  cxLookAndFeelPainters, dxMapControlTypes,
  dxMapControlBingMapImageryDataProvider, dxCustomMapItemLayer, dxMapItemLayer,
  cxClasses, dxMapLayer, dxMapImageTileLayer, dxMapControl, Vcl.ExtCtrls,
  Vcl.StdCtrls;

type
  TfrmMain = class(TForm)
    pnMap: TPanel;
    pnToolBox: TPanel;
    mcCarsPlaces: TdxMapControl;
    mlBingMap: TdxMapImageTileLayer;
    ilPolyLines: TdxMapItemLayer;
    ilCarsPoints: TdxMapItemLayer;
    btnGetCars: TButton;
    meLog: TMemo;
    Timer1: TTimer;
    procedure FormCreate(Sender: TObject);
    procedure btnGetCarsClick(Sender: TObject);
    procedure mcCarsPlacesCenterPointChanged(Sender: TObject);
  private
    FCarDetector: TCarDetector;
    procedure ZoomInToCenterMoscow;

    procedure SaveCarToDb(const ACar:TWheelyCar);
  public
    { Public declarations }
  end;
  procedure OnCarDetect(const ACar:TWheelyCar);
var
  frmMain: TfrmMain;

const
  constBingAPIKey: string = 'ArlyKldofYxmTMOXnHlmlQ-fbUJHSKAQlI6HRo_owmWYBYsPSwJ-6bwL2uI_P17B';
  constTaxiFileName = 'Taxi_1.png';

  constCenterMoscowTopLeftLatitude  = 55.767664;
  constCenterMoscowTopLeftLongitude = 37.596977;

  constCenterMoscowRightLatitude = 55.744125;
  constCenterMoscowRightLongitude = 37.658476;
implementation

{$R *.dfm}

procedure OnCarDetect(const ACar:TWheelyCar);
var
  lCar: TdxMapCustomElement;
begin
   if ACar.CarClass <> '"s-class-000000_1x.png"' then
    Exit;

  frmMain.meLog.Lines.Add(ACar.Id + ' ' + FloatToStr(ACar.CarPosition.Latitude) + ' ' + FloatToStr(ACar.CarPosition.Longitude) + ' ' + ACar.CarClass);
  lCar := TdxMapCustomElement(frmMain.ilCarsPoints.MapItems.Add(TdxMapCustomElement));
  lCar.Text := ACar.Id ;
  lCar.Location.Latitude := ACar.CarPosition.Latitude;
  lCar.Location.Longitude := ACar.CarPosition.Longitude;
end;

procedure TfrmMain.btnGetCarsClick(Sender: TObject);
var
  lZone: TZonePosition;
begin
  meLog.Clear;
  frmMain.ilCarsPoints.MapItems.Clear;
  lZone.Latitude := 55.751661;
  lZone.Longitude := 37.564349;

  FCarDetector.LoadCars(lZone);
   lZone.Latitude := 55.757265;
  lZone.Longitude := 37.620637;

  FCarDetector.LoadCars(lZone);
end;

procedure TfrmMain.FormCreate(Sender: TObject);
begin
  (mlBingMap.Provider as TdxMapControlBingMapImageryDataProvider).BingKey := constBingAPIKey;

  inherited;

  FCarDetector := TCarDetector.Create;
  FCarDetector.OnCarDetected := OnCarDetect;

  FormatSETTINGS.DecimalSeparator := '.';

  ZoomInToCenterMoscow;
end;

procedure TfrmMain.mcCarsPlacesCenterPointChanged(Sender: TObject);
var
  lZone: TZonePosition;
begin
  frmMain.ilCarsPoints.MapItems.Clear;
  lZone.Latitude := mlBingMap.CenterPoint.Latitude;
  lZone.Longitude :=  mlBingMap.CenterPoint.Longitude;

  FCarDetector.LoadCars(lZone);
end;

procedure TfrmMain.SaveCarToDb(const ACar: TWheelyCar);
begin

end;

procedure TfrmMain.ZoomInToCenterMoscow;
var
  lGeoRect:TdxMapControlGeoRect;
begin
  lGeoRect.TopLeft.Latitude :=  constCenterMoscowTopLeftLatitude;
  lGeoRect.TopLeft.Longitude :=  constCenterMoscowTopLeftLongitude;

  lGeoRect.BottomRight.Latitude := constCenterMoscowRightLatitude;
  lGeoRect.BottomRight.Longitude := constCenterMoscowRightLongitude;
  mcCarsPlaces.ZoomToGeoRect(lGeoRect);
end;

end.
